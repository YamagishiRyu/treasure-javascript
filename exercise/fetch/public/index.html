<!DOCTYPE html>
<html>
<head>
	<title>Index</title>
</head>
<body>
	<h1>Let's fetch</h1>

	<h3>#1 Success</h3>
	<textarea rows="10" cols="60" id="success" disabled></textarea>

	<h3>#2 Error</h3>
	<textarea rows="10" cols="60" id="error" style="color:red" disabled></textarea>

	<script type="text/javascript">
	const successHandler = function(text) {
		document.getElementById("success").textContent += JSON.stringify(text);
	}
	const errorHandler = function(error) {
		document.getElementById("error").textContent += `${error.name}: ${error.message}`;
	}

        class RetryError extends Error{}

        const statusHandler = function(response) {
          if(!response.ok){
            switch (true) {
              case /4../.test(response.status):
                throw Error(response.status + ": not Found\n")
              case /503/.test(response.status):
                throw RetryError(response.status + ": retry\n")
              case /5../.test(response.status):
                throw Error(response.status + ": Timeout\n")
              default:
                throw Error("something wrong")
            }
          }
          return response
        }

        const parseResponse = function(res) { 
          console.log(res.headers.get('content-type'))
          switch(res.headers.get('content-type')) {
            case 'application/json; charset=utf-8':
              return res.json()
            case 'text/html; charset=UTF-8':
              throw Error("Response is not json \n")
            default:
              return res
          }
        }

	// change this
        const request = function(method, url, body = {}, headers = {}) {
          return fetch(url, { method: method }).then(statusHandler).then(parseResponse)
	}

        const timeoutPromise = function(duration) {
          return new Promise(function(resolve, reject) {
            setTimeout(reject, duration, "Client Timeout\n");
          });
        } 

        const requestWithTimeout = function(duration) {
          return function(method, url, body={}, headers={}) {
            return Promise.race([request(method, url, body, headers), timeoutPromise(duration)]).catch(function(value) {
              if (value.constructor === RetryError) {
                return requestWithTimeout(duration)(method, url, body, headers)
              }
              throw Error(value)
            })
          }
        }

        const requestAll = function(requestInfos) {
          Promise.all(requestInfos.map(info => 
            requestWithTimeout(2000)(info.method, info.url, info.body, info.headers).then(successHandler).catch(errorHandler)
          ))
        }

	// #1 GET 2xx
	request("GET", "http://localhost:3001/posts").then(successHandler).catch(errorHandler)

	// #2 GET 4xx
	request("GET", "http://localhost:3001/404").then(successHandler).catch(errorHandler)

	// #3 GET 5xx
	request("GET", "http://localhost:3001/timeout").then(successHandler).catch(errorHandler)

	// #4 GET 2xx but not json
	request("GET", "http://localhost:3001/index.html").then(successHandler).catch(errorHandler)

	// #5 PUT
	request("PUT", "http://localhost:3001/posts/1", {"id": 1, "title": "treasure", "author": "{{CHANGE YOUR NAME}}" }).then(successHandler).catch(errorHandler)

	// #6 GET /timeout with Timeout
	requestWithTimeout(2000)("GET", "http://localhost:3001/timeout").then(successHandler).catch(errorHandler)

	// #7 GET /retryme until success
	requestWithTimeout(2000)("GET", "http://localhost:3001/retryme").then(successHandler).catch(errorHandler)

	// #8 [GET http://localhost:3001/posts/1, GET http://localhost:3001/comments?post_id=1]
        
        requestList = [ 
          { "url": "http://localhost:3001/posts/1", "methodl": "GET"},
          { "url": "http://localhost:3001/comments?post_id=1", "method": "GET"},
        ]
        requestAll(requestList)

	</script>
</body>
</html>
